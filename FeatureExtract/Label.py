
import os
import glob
import re

def findip(str):
    p = re.compile( r"((?:(?:25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d)))\.){3}(?:25[0-5]|2[0-4]\d|((1\d{2})|([1-9]?\d))))")
    res = p.findall(str)
    ips = [g[0] for g in res]
    if len(ips) == 0:
        return -1
    else:
        return ips[0]

def find_label_from_binetflow(binetflowPath):
    pathSplit = binetflowPath.split('\\')
    datasetName = pathSplit[-2]
    binetflowName = pathSplit[-1]
    print(">>>finding label from ", datasetName)

    infected_ips = {}
    normal_ips = {}


    with open(binetflowPath) as f:
        for line in f:
            if 'StartTime' in line:
                continue

            if "binetflow" in binetflowName:
                split = line.split(',')
                src_address = split[3]
            elif "netflow" in binetflowName:
                src_address = findip(line)
                if src_address == -1:
                    continue


            if "Botnet" in line:
                try:
                    infected_ips[src_address] = infected_ips[src_address] + 1
                except:
                    infected_ips[src_address] = 1
            elif "Normal" in line:
                try:
                    normal_ips[src_address] = normal_ips[src_address] + 1
                except:
                    normal_ips[src_address] = 1
            #if src_addr is infected, all the traffic from src_addr are considered as malware traffic
            for addr in infected_ips:
                if addr in normal_ips.keys():
                    normal_ips.pop(addr)
        f.close()
        print(">>>In ", datasetName, ", the infected ips are:\n", infected_ips)
        print(">>>In ", datasetName, ", the normal ips are:\n", normal_ips)



    return infected_ips, normal_ips


def create_conn_label(bro_folder, infected_ips, normal_ips):

    tab = '\t'
    malware_label = 0
    normal_label = 0
    flow_array = []

    try:
        print(">>>reading conn.log")
        with open(bro_folder + "\\conn.log") as f:
            for line in f:
                newline = line
                if not('#'==line[0]):
                    split = line.split(tab)
                    src_address = split[2]

                    if src_address in infected_ips:
                        newline = line.rstrip() + tab + "botnet\n"
                        malware_label += 1
                    elif src_address in normal_ips:
                        newline = line.rstrip() + tab + "normal\n"
                        normal_label += 1
                    else:
                        newline = line.rstrip() + tab + "background\n"
                else:
                    if "fields" in line:
                        newline = line.rstrip() + tab + "label\n"
                    elif "types" in line:
                        newline  = line.rstrip() + tab + "string\n"
                flow_array.append(newline)
            f.close()
            print("malwares:", malware_label)
            print("normals:", normal_label)

        try:
            print(">>>creating conn_label.log")
            # dir = bro_folder + "\\self_create"
            # if not os.path.exists(dir):
            #     os.makedirs(dir)
            with open(bro_folder + "\\conn_label.log", 'w')as f:
                for flow in flow_array:
                    f.write(flow)
                f.close()
        except:
            print(">>>Error: cannot create conn_label.log")

    except:
        print(">>>Error: cannot read conn.log")


def find_binetflow_name(databasePath):
    binetflow_files = glob.glob(databasePath+"/*netflow")
    return binetflow_files




datasetPath = "D:\\Work\\PyCharm-workspace\\MalwareTrafficDetection\\Dataset"
databasePaths = glob.glob(datasetPath+"/CTU*")

for databasePath in databasePaths:
    binetflow_paths = find_binetflow_name(databasePath)
    for binetflow_path in binetflow_paths:
        infected_ips, normal_ips = find_label_from_binetflow(binetflow_path)
        if len(infected_ips)==0 and len(normal_ips)==0:
            continue
        else:
            bro_folder = binetflow_path.split('.')[0]
            create_conn_label(bro_folder, infected_ips, normal_ips)



