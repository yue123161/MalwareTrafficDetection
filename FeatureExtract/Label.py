
import os
import glob

def find_label_from_binetflow(binetflowPath):
    pathSplit = binetflowPath.split('\\')
    datasetName = pathSplit[-2]
    print(">>>finding label from ", datasetName)

    infected_ips = {}
    normal_ips = {}

    try:
        with open(binetflowPath) as f:
            for line in f:
                if 'StartTime' in line:
                    continue

                split = line.split(',')
                label = split[14]
                src_address = split[3]

                if "From-Botnet" in label:
                    try:
                        infected_ips[src_address] = infected_ips[src_address] + 1
                    except:
                        infected_ips[src_address] = 1
                elif "From-Normal" in label:
                    try:
                        normal_ips[src_address] = normal_ips[src_address] + 1
                    except:
                        normal_ips[src_address] = 1
            f.close()
            print(">>>In ", datasetName, ", the infected ips are:\n", infected_ips)
            print(">>>In ", datasetName, ", the normal ips are:\n", normal_ips)
    except:
        print(">>>Error: cannot read ", pathSplit[-1])


    return infected_ips, normal_ips


def create_conn_label(databasePath, infected_ips, normal_ips):

    tab = '\t'
    malware_label = 0
    normal_label = 0
    flow_array = []

    try:
        print(">>>reading conn.log")
        with open(databasePath + "\\bro\\conn.log") as f:
            for line in f:
                newline = line
                if not('#'==line[0]):
                    split = line.split(tab)
                    src_address = split[2]

                    if src_address in infected_ips:
                        newline = line.rstrip() + tab + "botnet\n"
                        malware_label += 1
                    elif src_address in normal_ips:
                        newline = line.rstrip() + tab + "normal\n"
                        normal_label += 1
                    else:
                        newline = line.rstrip() + tab + "background\n"
                else:
                    if "fields" in line:
                        newline = line.rstrip() + tab + "label\n"
                    elif "types" in line:
                        newline  = line.rstrip() + tab + "string\n"
                flow_array.append(newline)
            f.close()
            print("malwares:", malware_label)
            print("normals:", normal_label)

        try:
            print(">>>creating conn_label.log")
            dir = databasePath + "\\bro\\self_create"
            if not os.path.exists(dir):
                os.makedirs(dir)
            with open(dir + "\\conn_label.log", 'w')as f:
                for flow in flow_array:
                    f.write(flow)
                f.close()
        except:
            print(">>>Error: cannot create conn_label.log")

    except:
        print(">>>Error: cannot read conn.log")


def find_binetflow_name(databasePath):
    binetflow_files = glob.glob(databasePath+"/*.binetflow")
    if len(binetflow_files)>1 or len(binetflow_files) == 0:
        return -1
    return binetflow_files[0]


datasetPath = "D:\\Work\\PyCharm-workspace\\MalwareTrafficDetection\\Dataset"
databasePaths = glob.glob(datasetPath+"/*")

for databasePath in databasePaths:
    binetflow_path = find_binetflow_name(databasePath)
    infected_ips, normal_ips = find_label_from_binetflow(binetflow_path)
    create_conn_label(databasePath, infected_ips, normal_ips)



