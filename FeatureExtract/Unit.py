import sys

class Unit:
    unitID = ""
    label = ""

    # connection parameters
    conn_ts = []
    conn_uid = []
    conn_orig_h = []
    conn_orig_p = []
    conn_resp_h = []
    conn_resp_p = []
    conn_proto = []
    conn_service = []
    conn_duration = []
    conn_orig_bytes = []
    conn_resp_bytes = []
    conn_state = []
    conn_local_orig = []
    conn_local_resp = []
    conn_missed_bytes = []
    conn_history = []
    conn_orig_pkts = []
    conn_orig_ip_bytes = []
    conn_resp_pkts = []
    conn_resp_ip_bytes = []
    conn_tunnel_parents = []


    #ssl parameters
    ssl_time = []
    ssl_uid = []
    version = []
    cipher = []
    curve = []
    server_name = []
    resumed = []
    last_alert = []
    next_protocol = []
    established = []
    cert_chain_fuids = []
    client_cert_chain_fuids = []
    subject = []
    issuer = []
    client_subject = []
    client_issuer = []
    validation_status = []
    notary_first_seen = []
    notary_last_seen = []
    notary_times_seen = []
    notary_valid = []



    # connection features
    duration_mean = 0
    duration_standard_deviation = 0
    duration_standard_deviation_range = 0
    orig_bytes_mean = 0
    orig_bytes_standard_deviation = 0
    orig_bytes_standard_deviation_range = 0
    resp_bytes_mean = 0
    resp_bytes_standard_deviation = 0
    resp_bytes_standard_deviation_range = 0
    orig_bytes_ratio = 0
    orig_pkts_mean = 0
    orig_pkts_standard_deviation = 0
    orig_pkts_standard_deviation_range = 0
    resp_pkts_mean = 0
    resp_pkts_standard_deviation = 0
    resp_pkts_standard_deviation_range = 0
    orig_pkts_ratio = 0
    periodicity_mean = 0
    periodicity_standard_deviation = 0
    periodicity_standard_deviation_range = 0
    #[S0 S1 SF REJ S2 S3 RSTO RSTR RSTOS0 RSTRH SH SHR OTH]
    conn_state_ratio = [0,0,0,0,0,0,0,0,0,0,0,0,0]

    #ssl features
    ssl_ratio = 0


    def __init__(self, unitID, label):
        self.unitID = unitID
        self.label = label




    def add_conn_label_log(self, conn_label_line):
        '''
        add a data line from conn_label.log
        :param conn_label_line: the data line
        :return:
        '''
        tab = '\t'
        split = conn_label_line.split(tab)
        if not (split[0] == '-' or split[8] == '-' or split[9] == '-' or split[10] == '-' or split[16] == '-' or split[18] == '-' or "background" in line):

            self.conn_ts.append(float(split[0]))
            self.conn_uid.append(split[1])
            self.conn_orig_h.append(split[2])
            self.conn_orig_p.append(split[3])
            self.conn_resp_h.append(split[4])
            self.conn_resp_p.append(split[5])
            self.conn_proto.append(split[6])
            self.conn_service.append(split[7])
            self.conn_duration.append(float(split[8]))
            self.conn_orig_bytes.append(float(split[9]))
            self.conn_resp_bytes.append(float(split[10]))
            self.conn_state.append(split[11])
            self.conn_local_orig.append(split[12])
            self.conn_local_resp.append(split[13])
            self.conn_missed_bytes.append(split[14])
            self.conn_history.append(split[15])
            self.conn_orig_pkts.append(float(split[16]))
            self.conn_orig_ip_bytes.append(split[17])
            self.conn_resp_pkts.append(float(split[18]))
            self.conn_resp_ip_bytes.append(split[19])
            self.conn_tunnel_parents.append(split[20])

        else:
            print(conn_label_line)

    def add_ssl_log(self, ssl_line):
        """
        add a data line from ssl.log
        :param ssl_line: the data line
        :return:
        """
        tab = '\t'
        split = ssl_line.split(tab)

        self.ssl_time.append(split[0])
        self.ssl_uid.append(split[1])
        self.version.append(split[6])
        self.cipher.append(split[7])
        self.curve.append(split[8])
        self.server_name.append(split[9])
        self.resumed.append(split[10])
        self.last_alert.append(split[11])
        self.next_protocol.append(split[12])
        self.established.append(split[13])
        self.cert_chain_fuids.append(split[14])
        self.client_cert_chain_fuids.append(split[15])
        self.subject.append(split[16])
        self.issuer.append(split[17])
        self.client_subject.append(split[18])
        self.client_issuer.append(split[19])
        self.validation_status.append(split[20])
        self.notary_first_seen.append(split[21])
        self.notary_last_seen.append(split[22])
        self.notary_times_seen.append(split[23])
        self.notary_valid.append(split[24])





    def compute_conn_features(self):



        self.duration_mean = self.mean(self.conn_duration)
        self.duration_standard_deviation = self.standard_deviation(self.conn_duration)
        self.duration_standard_deviation_range = self.standard_deviation_range(self.conn_duration)
        self.orig_bytes_mean = self.mean(self.conn_orig_bytes)
        self.orig_bytes_standard_deviation = self.standard_deviation(self.conn_orig_bytes)
        self.orig_bytes_standard_deviation_range = self.standard_deviation_range(self.conn_orig_bytes)
        self.resp_bytes_mean = self.mean(self.conn_resp_bytes)
        self.resp_bytes_standard_deviation = self.standard_deviation(self.conn_resp_bytes)
        self.resp_bytes_standard_deviation_range = self.standard_deviation_range(self.conn_resp_bytes)
        self.orig_bytes_ratio = self.ratio(self.conn_orig_bytes, self.conn_resp_bytes)
        self.orig_pkts_mean = self.mean(self.conn_orig_pkts)
        self.orig_pkts_standard_deviation = self.standard_deviation(self.conn_orig_pkts)
        self.orig_pkts_standard_deviation_range = self.standard_deviation_range(self.conn_orig_pkts)
        self.resp_pkts_mean = self.mean(self.conn_resp_pkts)
        self.resp_pkts_standard_deviation = self.mean(self.conn_resp_pkts)
        self.resp_pkts_standard_deviation_range = self.standard_deviation_range(self.conn_resp_pkts)
        self.orig_pkts_ratio = self.ratio(self.conn_orig_pkts, self.conn_resp_pkts)
        #compute periodicity
        if len(self.conn_ts) == 1:
            self.periodicity_mean = 0
            self.periodicity_standard_deviation = 0
            self.periodicity_standard_deviation_range = 0
        else:
            firstTime = []
            for i in range(1, len(self.conn_ts)):
                firstTime.append(self.conn_ts[i]-self.conn_ts[i-1])
            self.periodicity_mean = self.mean(firstTime)
            self.periodicity_standard_deviation = self.standard_deviation(firstTime)
            self.periodicity_standard_deviation_range = self.standard_deviation_range(firstTime)

        for state in self.conn_state:
            i = ["S0","S1","SF","REJ","S2","S3","RSTO","RSTR","RSTOS0","RSTRH","SH","SHR","OTH"].index(state)
            self.conn_state_ratio[i] += 1
        for ratio in self.conn_state_ratio:
            self.conn_state_ratio[ratio] = self.conn_state_ratio[ratio]/len(self.conn_state_ratio)


    def mean(self, list):
        """
        compute mean
        :param list: number list
        :return: mean
        """
        sum = 0
        for i in list:
            sum += i
        return sum/len(list)

    def standard_deviation(self, list):
        """
        compute standard deviation
        :param list: number list
        :return: standard deviation
        """
        powersum = 0
        for i in list:
            powersum += pow(i, 2)
        return pow(powersum/len(list)-pow(self.mean(list), 2), 0.5)

    def standard_deviation_range(self, list):
        """
        compute standard deviation range
        :param list: number list
        :return: standard deviation range
        """
        up = self.mean(list) + self.standard_deviation(list)
        down = self.mean(list) - self.standard_deviation(list)
        sum = 0
        for i in list:
            if i>up or i<down:
                sum += 1
        return sum/len(list)

    def ratio(self, lista, listb):
        """
        compute the percentage of lista sum
        :param lista: number list
        :param listb: number list
        :return: percentage
        """
        suma = 0
        sumb = 0
        for i in lista:
            suma += i
        for j in listb:
            sumb += j
        return suma/(suma+sumb)


def extract_unitID_label(line):
    """
    extract unitID and label from data line in conn_label
    :param line: data line in conn_label.log
    :return: unit string, label string
    """
    tab = '\t'
    split = line.split(tab)
    return split[2] + tab + split[4] + tab + split[5] + tab + split[6], split[21]

def numberlist2elementstring(list):
    line = "" + str(list[0])
    for i in range(1, len(list)):
        line = line + tab + list[i]
    return line

if __name__ == '__main__':
    if len(sys.argv) == 3:
        conn_label_log_path = sys.argv[1]
        conn_features_path = sys.argv[2]


        print(">>>start to read conn_label and compute features")
        conn_label_log_path = "D:\\Work\PyCharm-workspace\\MalwareTrafficDetection\\Dataset\\CTU-Malware-Capture-Botnet-42\\bro\\self_create\\conn_label.log"
        # conn_label_log_path = "/home/jiyuan/Work/MalwareTrafficDetection/Dataset/CTU-Malware-Capture-Botnet-42/bro/self_create/conn_label.log"
        unitDict = {}

        with open(conn_label_log_path) as f:
            for line in f:
                if not line[0] == '#':
                    unitID, label = extract_unitID_label(line)
                    if "background" not in line:
                        if unitID not in unitDict:
                            unitDict[unitID] = Unit(unitID, label)
                        #ssl_flag is default normal, revise when reading ssl_log
                        unitDict[unitID].add_conn_label_log(line)
            num = 0
            for unitID in unitDict:
                unitDict[unitID].compute_conn_features()
                num += 1
                if(num%100 == 0):
                    print(num, "/", len(unitDict))
            f.close()
        print(">>>finish reading conn_label and compute features")

        print(">>>start to write into conn_features")
        tab = '\t'
        conn_features_path = "D:\\Work\PyCharm-workspace\\MalwareTrafficDetection\\Dataset\\CTU-Malware-Capture-Botnet-42\\bro\\self_create\\conn_features.log"
        # conn_features_path = "/home/jiyuan/Work/MalwareTrafficDetection/Dataset/CTU-Malware-Capture-Botnet-42/bro/self_create/conn_features.log"
        with open(conn_features_path, 'w') as f:
            for unitID in unitDict.keys():
                unit = unitDict[unitID]
                f.write(str(unit.ssl_ratio ) + tab + str(unit.duration_mean ) + tab + str(unit.duration_standard_deviation ) + tab + str(unit.duration_standard_deviation_range ) + tab + str(unit.orig_bytes_mean ) + tab + str(unit.orig_bytes_standard_deviation ) + tab + str(unit.orig_bytes_standard_deviation_range ) + tab + str(unit.resp_bytes_mean ) + tab + str(unit.resp_bytes_standard_deviation ) + tab + str(unit.resp_bytes_standard_deviation_range ) + tab + str(unit.orig_bytes_ratio ) + tab + str(unit.orig_pkts_mean ) + tab + str(unit.orig_pkts_standard_deviation ) + tab + str(unit.orig_pkts_standard_deviation_range ) + tab + str(unit.resp_pkts_mean ) + tab + str(unit.resp_pkts_standard_deviation ) + tab + str(unit.resp_pkts_standard_deviation_range ) + tab + str(unit.orig_pkts_ratio ) + tab + str(unit.periodicity_mean ) + tab + str(unit.periodicity_standard_deviation ) + tab + str(unit.periodicity_standard_deviation_range ) + tab + numberlist2elementstring(unit.conn_state_ratio ) + '\n')
            f.close()
            print(">>>finish writing into conn_features")
    else:
        print(">>>Error:program is required 2 parameters")
































