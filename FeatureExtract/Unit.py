class Unit:
    unitID = ""
    # label 1 malware 0 normal
    label = 0

    # connection parameters
    conn_time = []
    uid = []
    ssl_conn = []
    duration = []
    orig_bytes = []
    resp_bytes = []
    orig_pkts = []
    resp_pkts = []
    conn_state = []

    # connection features
    ssl_ratio = 0
    duration_mean = 0
    duration_standard_deviation = 0
    duration_standard_deviation_range = 0
    orig_bytes_mean = 0
    orig_bytes_standard_deviation = 0
    orig_bytes_standard_deviation_range = 0
    resp_bytes_mean = 0
    resp_bytes_standard_deviation = 0
    resp_bytes_standard_deviation_range = 0
    orig_bytes_ratio = 0
    orig_pkts_mean = 0
    orig_pkts_standard_deviation = 0
    orig_pkts_standard_deviation_range = 0
    resp_pkts_mean = 0
    resp_pkts_standard_deviation = 0
    resp_pkts_standard_deviation_range = 0
    orig_pkts_ratio = 0
    periodicity_mean = 0
    periodicity_standard_deviation = 0
    periodicity_standard_deviation_range = 0
    established_connection_states_ratio = 0

    #ssl features

    def __init__(self, unitID):
        self.unitID = unitID


    def add_conn_label_log(self, conn_label_line, ssl_flag):
        '''
        add a data line from conn_label.log
        :param conn_label_line: the data line
        :param ssl_flag: 1 ssl 0 non-ssl
        :return:
        '''
        split = conn_label_line.split("\t")
        unitID = split[2] + "\t" + split[4] + "\t" + split[5] + "\t" + split[6]
        if not split[21] == "background":
            if self.unitID == unitID:
                self.conn_time.append(split[0])
                self.uid.append(split[1])
                self.ssl_conn.append(ssl_flag)
                self.duration.append(split[8])
                self.orig_bytes.append(split[9])
                self.resp_bytes.append(split[10])
                if split[11] in ["SF", "S1", "S2", "S3", "RSTO", "RSTR"]:
                    self.conn_state.append(1)
                else:
                    self.conn_state.append(0)
                self.orig_pkts.append(split[16])
                self.resp_pkts.append(split[18])
                if split[21] == "botnet":
                    self.label = 1
                elif split[21] == "normal":
                    self.label = 0
            else:
                print(">>>Error: wrong unit")


    def compute_conn_features(self):

        self.ssl_ratio = self.mean(self.ssl_conn)
        self.duration_mean = self.mean(self.duration)
        self.duration_standard_deviation = self.standard_deviation(self.duration)
        self.duration_standard_deviation_range = self.standard_deviation_range(self.duration)
        self.orig_bytes_mean = self.mean(self.orig_bytes)
        self.orig_bytes_standard_deviation = self.standard_deviation(self.orig_bytes)
        self.orig_bytes_standard_deviation_range = self.standard_deviation_range(self.orig_bytes)
        self.resp_bytes_mean = self.mean(self.resp_bytes)
        self.resp_bytes_standard_deviation = self.standard_deviation(self.resp_bytes)
        self.resp_bytes_standard_deviation_range = self.standard_deviation_range(self.resp_bytes)
        self.orig_bytes_ratio = self.ratio(self.orig_bytes, self.resp_bytes)
        self.orig_pkts_mean = self.mean(self.orig_pkts)
        self.orig_pkts_standard_deviation = self.standard_deviation(self.orig_pkts)
        self.orig_pkts_standard_deviation_range = self.standard_deviation_range(self.orig_pkts)
        self.resp_pkts_mean = self.mean(self.resp_pkts)
        self.resp_pkts_standard_deviation = self.mean(self.resp_pkts)
        self.resp_pkts_standard_deviation_range = self.standard_deviation_range(self.resp_pkts)
        self.orig_pkts_ratio = self.ratio(self.orig_pkts, self.resp_pkts)
        #compute periodicity
        if len(self.conn_time) == 1:
            self.periodicity_mean = 0
            self.periodicity_standard_deviation = 0
            self.periodicity_standard_deviation_range = 0
        else:
            firstTime = []
            for i in range(1, len(self.conn_time)):
                firstTime.append(self.conn_time[i]-self.conn_time[i-1])
            self.periodicity_mean = self.mean(firstTime)
            self.periodicity_standard_deviation = self.standard_deviation(firstTime)
            self.periodicity_standard_deviation_range = self.standard_deviation_range(firstTime)
        self.established_connection_states_ratio = self.mean(self.conn_state)


    def mean(self, list):
        """
        compute mean
        :param list: number list
        :return: mean
        """
        sum = 0
        for i in list:
            sum += i
        return sum/len(list)

    def standard_deviation(self, list):
        """
        compute standard deviation
        :param list: number list
        :return: standard deviation
        """
        powersum = 0
        for i in list:
            powersum += pow(i, 2)
        return pow(powersum/len(list)-pow(self.mean(list), 2), 0.5)

    def standard_deviation_range(self, list):
        """
        compute standard deviation range
        :param list: number list
        :return: standard deviation range
        """
        up = self.mean(list) + self.standard_deviation(list)
        down = self.mean(list) - self.standard_deviation(list)
        sum = 0
        for i in list:
            if i>up or i<down:
                sum += 1
        return sum/len(list)

    def ratio(self, lista, listb):
        """
        compute the percentage of lista sum
        :param lista: number list
        :param listb: number list
        :return: percentage
        """
        suma = 0
        sumb = 0
        for i in lista:
            suma += i
        for j in listb:
            sumb += j
        return suma/(suma+sumb)


def extract_unitID(line):
    """
    extract uid from data line in conn_label
    :param line: data line in conn_label
    :return: unit string
    """
    split = line.split("\t")
    return split[2] + "\t" + split[4] + "\t" + split[5] + "\t" + split[6]

conn_label_log_path = ""
unitDict = {}
try:
    with open(conn_label_log_path) as f:
        for line in f:
            if not line[0] == '#':
                unitID = extract_unitID()
                if unitID not in unitDict:
                    unitDict[unitID] = Unit(unitID)
                unitDict[unitID].add_conn_label_log(line)
        for unitID in unitDict.keys():
            unitDict[unitID].compute_conn_features()
        f.close()
except:
    print(">>>Error: connot open conn_label file")

conn_features_path = ""
try:
    with open(conn_features_path, 'w') as f:
        for unitID in unitDict.keys():
            unit = unitDict[unitID]
            f.write(unit.ssl_ratio + "\t")
            f.write(unit.duration_mean + "\t")
            f.write(unit.duration_standard_deviation + "\t")
            f.write(unit.duration_standard_deviation_range + "\t")
            f.write(unit.orig_bytes_mean + "\t")
            f.write(unit.orig_bytes_standard_deviation + "\t")
            f.write(unit.orig_bytes_standard_deviation_range + "\t")
            f.write(unit.resp_bytes_mean + "\t")
            f.write(unit.resp_bytes_standard_deviation + "\t")
            f.write(unit.resp_bytes_standard_deviation_range + "\t")
            f.write(unit.orig_bytes_ratio + "\t")
            f.write(unit.orig_pkts_mean + "\t")
            f.write(unit.orig_pkts_standard_deviation + "\t")
            f.write(unit.orig_pkts_standard_deviation_range + "\t")
            f.write(unit.resp_pkts_mean + "\t")
            f.write(unit.resp_pkts_standard_deviation + "\t")
            f.write(unit.resp_pkts_standard_deviation_range + "\t")
            f.write(unit.orig_pkts_ratio + "\t")
            f.write(unit.periodicity_mean + "\t")
            f.write(unit.periodicity_standard_deviation + "\t")
            f.write(unit.periodicity_standard_deviation_range + "\t")
            f.write(unit.established_connection_states_ratio + "\t")
            f.write(unit.label + "\n")
except:
    print(">>>Error: connot create conn_featrues")
# u = Unit("68.52.88.162\t147.32.84.59\t6881\ttcp")
# u.add_conn_label_log("1312962415.742160	Cm4Iyt3EZ8wcV3lhvk	68.52.88.162	49883	147.32.84.59	6881	tcp	-	0.000016	0	0	REJ	-	-	0	Sr	1	52	1	40	(empty)	malware", 0)
# print(u.unit)
# print(u.conn_time)
# print(u.conn_state)
# print(u.ssl_conn)
# print(u.label)
































