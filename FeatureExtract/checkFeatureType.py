"""
this file aims to find out types of certain features
"""
import re

def checkip(ip):
    p = re.compile('^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$')
    if p.match(ip):
        return True
    else:
        return False


def print_type(dict):
    print(len(dict), dict)
    # if len(dict) < 100:
    #     print(len(dict), dict)
    # else:
    #     print("too many types")

def find_ssl_type():
    tab = '\t'
    version = set()
    cipher = set()
    server_name = set()
    resumed = set()
    last_alert = set()
    next_protocol = set()
    established = set()
    cert_chain_fuids = set()
    subject = set()
    issuer = set()
    client_subject = set()
    client_issuer = set()
    validation_status = set()
    notaryfirst_seen = set()
    notarylast_seen = set()
    notarytimes_seen = set()
    notaryvalid = set()
    ssl_log_path = "D:\\Work\PyCharm-workspace\\MalwareTrafficDetection\\Dataset\\CTU-Malware-Capture-Botnet-42\\bro\\ssl.log"
    for i in range(42, 43):
        ssl_log_path = "D:\\Work\PyCharm-workspace\\MalwareTrafficDetection\\Dataset\\CTU-Malware-Capture-Botnet-" + str(i) + "\\bro\\ssl.log"
        with open(ssl_log_path) as f:
            for line in f:
                if '#' not in line:
                    split = line.split(tab)
                    version.add(split[6])
                    cipher.add(split[7])
                    if(checkip(split[9]) or split[9] == '-'):
                        server_name.add(split[9])
                    # server_name.add(split[9])
                    resumed.add(split[10])
                    last_alert.add(split[11])
                    next_protocol.add(split[12])
                    established.add(split[13])
                    cert_chain_fuids.add(split[14])
                    subject.add(split[16])
                    issuer.add(split[17])
                    client_subject.add(split[18])
                    client_issuer.add(split[19])
                    validation_status.add(split[20])
                    notaryfirst_seen.add(split[21])
                    notarylast_seen.add(split[22])
                    notarytimes_seen.add(split[23])
                    notaryvalid.add(split[24])

            f.close()
    print(len(version), ": ", version)
    print(len(cipher), ":", cipher)
    print(len(server_name), ": ", server_name)
    print(len(resumed), ": ", resumed)
    print(len(last_alert), ": ", last_alert)
    print(len(next_protocol), ": ", next_protocol)
    print(len(established), ": ", established)
    print_type(cert_chain_fuids)
    print_type(subject)#
    print_type(issuer)#
    print_type(client_subject)
    print_type(client_issuer)
    print_type(validation_status)
    print_type(notaryfirst_seen)
    print_type(notarylast_seen)
    print_type(notarytimes_seen)
    print_type(notaryvalid)


def find_conn_type():
    tab = '\t'
    conn_state = set()
    for i in range(42, 54):
        ssl_log_path = "D:\\Work\PyCharm-workspace\\MalwareTrafficDetection\\Dataset\\CTU-Malware-Capture-Botnet-" + str(i) + "\\bro\\self_create\\conn_label.log"
        with open(ssl_log_path) as f:
            for line in f:
                if '#' not in line:
                    split = line.split(tab)
                    conn_state.add(split[11])
            f.close()
    print(conn_state)

def find_cert_type():
    tab = '\t'
    cert_version = set()
    cert_serial = set()
    cert_key_alg = set()
    cert_sig_alg = set()
    cert_key_type = set()
    cert_key_length = set()
    cert_exponent = set()
    cert_curve = set()
    cert_san_dns = set()
    cert_san_uri = set()
    cert_san_email = set()
    cert_san_ip = set()
    cert_basic_constraints_ca = set()
    cert_basic_constraints_path_len = set()
    flag = False
    for i in range(42, 54):
        cert_log_path = "D:\\Work\PyCharm-workspace\\MalwareTrafficDetection\\Dataset\\CTU-Malware-Capture-Botnet-" + str(i) + "\\bro\\x509.log"
        with open(cert_log_path) as f:
            for line in f:
                if '#' not in line:
                    split = line.split(tab)
                    cert_version.add(split[2])
                    cert_serial.add(split[3])
                    # if split[6] == '-' or split[7] == '-':
                    #     print("there is -")
                    cert_key_alg.add(split[8])
                    cert_sig_alg.add(split[9])
                    cert_key_type.add(split[10])
                    cert_key_length.add(split[11])
                    cert_exponent.add(split[12])
                    cert_curve.add(split[13])
                    cert_san_dns.add(split[14])
                    cert_san_uri.add(split[15])
                    cert_san_email.add(split[16])
                    cert_san_ip.add(split[17])
                    cert_basic_constraints_ca.add(split[18])
                    cert_basic_constraints_path_len.add(split[19])
            f.close()
    print(len(cert_version), ": ", cert_version)
    print(len(cert_serial), ": ", cert_serial)
    print(len(cert_key_alg), ": ", cert_key_alg)
    print(len(cert_sig_alg), ": ", cert_sig_alg)
    print(len(cert_key_type), ": ", cert_key_type)
    print(len(cert_key_length), ": ", cert_key_length)
    print(len(cert_exponent), ": ", cert_exponent)
    print(len(cert_curve), ": ", cert_curve)
    print("certificate end")
    print(len(cert_san_dns), ": ", cert_san_dns)
    print(len(cert_san_uri), ": ", cert_san_uri)
    print(len(cert_san_email), ": ", cert_san_email)
    print(len(cert_san_ip), ": ", cert_san_ip)
    print(len(cert_basic_constraints_ca), ": ", cert_basic_constraints_ca)
    print(len(cert_basic_constraints_path_len), ": ", cert_basic_constraints_path_len)

    if ('-' in cert_san_dns):
        print("yes")


find_ssl_type()
# find_conn_type()
# find_cert_type()